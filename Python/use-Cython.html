<!DOCTYPE HTML>
<html lang="zh">
<head>
<title>如何使用Cython | Septicmk</title>
<link rel="alternate" hreflang="zh-Hans" href="blog.septicmk.com/Python/use-Cython.html">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name = "author" content="septicmk"> 
  <meta name = "description" content="如何使用Cython"><meta name = "Keywords" content="Cython, python, C">
  <link rel="stylesheet" href="/source/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="/source/css/font-awesome.css" type="text/css">
  <link rel="stylesheet" href="/source/css/style.css"  type="text/css">
  <link rel="stylesheet" href="/source/css/highlight.css" type="text/css">
  <link rel="stylesheet" href="/source/css/pygments.css" type="text/css">
  <link rel="stylesheet" href="/source/css/google-fonts.css" type="text/css">
  <link rel="stylesheet" href="/source/css/responsive.css" type="text/css">  
  <link rel="stylesheet" href="/source/css/sidenav.css" type="text/css">  
  <script src="/source/js/jquery-2.0.3.min.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?5961146e40694f9283fe6e71f55cec31";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body  id="body" data-spy="scroll" data-target=".toc">
<nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation" style="opacity: 1;">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/index.html">Septicmk</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  		  
		  <li>
			<a href="/links.html" title="Links">
			  <i class="fa fa-user"></i>Links
			</a>
		  </li>
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

    <div class="container" id="container">
        <div class=content>
            <div class=page-header>
                <h1>
                    <a class="brand" href="/index.html" hreflang="zh">Septicmk</a>
                    <span class="split"></span>
                    <span class="title">如何使用Cython</span>
                </h1>
            </div>
            <div class="row page">
                <div class="col-xs-12 col-sm-3 col-md-3 toc">
                    <!-- toc -->
                    <script type="text/javascript">
		                jQuery(document).ready(function() {
 		                        generateWikiTOC('.note', '.toc', 2, 2);
		                });
                    </script>
                </div>
                <div class="col-xs-12 col-sm-9 col-md-9 note">
                    <hr>
<p>如果需要对python代码添加C/C++的代码，我认为最优先考虑使用的应当是<a href="http://cython.org/">Cython</a>，当然也有其他的方法，比如<a href="http://segmentfault。com/a/1190000000479951#articleHeader11">这篇文章所说</a>。Cython除了能调用原生的C/C++模块外，还可以让你以python的语法来写C/C++的扩展。不过这当中有不少的Tips和Tricks值得注意.</p>
<div class="alert alert-info">

    <i class="fa fa-info"></i>

    本文中python==2.7.10， Cython=0.22.1
</div><h2 id="toc-0">Cython怎么工作?</h2>
<p>首先，<a href="https://docs.python.org/2/c-api/">Python-C-API</a>是Python解释器中原生的python模块，通过这个API就可以使用C/C++来编写Python扩展。不过为了使Python成功的调用C/C++模块，你得花大量的时间写低级的控制，来包裹原来的代码。而Cython所做的就是通过编译利用Python-C-API帮你完成了这个工作，并最终把它编进一个共享库文件(.so)中。使得你可以在python代码中通过<code>import</code>直接导入进来。</p>
<p>一般来讲，在python中使用C/C++模块两种常见的场景是:</p>
<ul>
<li>原来的python代码性能太差</li>
<li>有现成的C/C++可供直接调用</li>
</ul>
<p>首先，你至少得写一个.pyx的文件，写好外部调用的接口函数，然后一个setup.py文件，顺利的话，会生成一个共享库文件(.so)，就可以在python代码中<code>import</code>它了.<br>
比如说，如果你要写一个add(x，y)函数，首先:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># add.pyx</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</td></tr></table></div>
<p>然后一个编译文件:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># setup.py</span>
<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">Cython.Build</span> <span class="kn">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;add&#39;</span><span class="p">,</span>
  <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="s">&quot;add.pyx&quot;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>然后编译:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>python setup.py build_ext --inplace
</pre></div>
</td></tr></table></div>
<p>在你需要调用的地方:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># main.py</span>
<span class="kn">import</span> <span class="nn">add</span>
<span class="k">print</span> <span class="n">add</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<h2 id="toc-1">使用Cython语法</h2>
<h3 id="toc-2">定义变量</h3>
<p>使用<code>cdef</code>来定义变量，结构体，常量。</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">cdef</span> <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span>
<span class="n">cdef</span> <span class="n">struct</span> <span class="n">node</span><span class="p">:</span>
    <span class="nb">int</span> <span class="n">key</span>
    <span class="nb">float</span> <span class="n">value</span>
<span class="n">cdef</span> <span class="n">enum</span><span class="p">:</span>
    <span class="n">const</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">cdef</span> <span class="n">bint</span> <span class="n">flag</span> <span class="c"># bool类型使用bint代替</span>
</pre></div>
</td></tr></table></div>
<p>你可以用一个cdef来把他们写到一起:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">cdef</span><span class="p">:</span>
    <span class="n">cdef</span> <span class="n">struct</span> <span class="n">node</span><span class="p">:</span>
        <span class="nb">int</span> <span class="n">key</span>
        <span class="nb">float</span> <span class="n">value</span>
    <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span>
    <span class="n">void</span> <span class="n">add</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</td></tr></table></div>
<p>还可以使用<code>ctypedef</code>来定义类型名称。</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">ctypedef</span> <span class="nb">long</span> <span class="nb">long</span> <span class="n">LL</span>
</pre></div>
</td></tr></table></div>
<h3 id="toc-3">函数</h3>
<p>在Cython中有3种函数定义:</p>
<ul>
<li><code>def</code>: 传入python对象，返回python对象，直接调用</li>
<li><code>cdef</code>: 传入python对象或C/C++值，返回python对象或C/C++值，不可直接调用</li>
<li><code>cpdef</code>: 以上两者的混合<br>
注意:只有<code>def</code>和<code>cpdef</code>定义的函数在编译后可以在python代码中直接调用，<code>cdef</code>定义的函数则不能。
不过你可以使用<code>def</code>来对外封装:<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">fib_cdef</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">):</span>
  <span class="n">cdef</span> <span class="nb">int</span> <span class="n">fib_in_c</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">n</span>
      <span class="k">return</span> <span class="n">fib_in_c</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib_in_c</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">fib_in_c</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
那么这3个函数性能如何呢，可以看<a href="http://notes-on-cython.readthedocs.org/en/latest/fibo_speed.html">这篇评测</a>    </li>
</ul>
<div class="alert alert-info">

    <i class="fa fa-info"></i>

    结论: 使用cdef会变得更快，基本和直接用C差不多
</div><p>然而使用<code>cdef</code>报错不能很好的捕获异常。你可以这样使用</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">cdef</span> <span class="nb">int</span> <span class="n">divide</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">)</span> <span class="k">except</span> <span class="mi">0</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</td></tr></table></div>
<p>这样当该函数内部出错时，将会返回一个0。(所以此时应当避免正确的情况中有返回0的可能，以避免歧义。)</p>
<h3 id="toc-4">参数传递</h3>
<p>如上所示，传递一个值是很简单的，只要稍稍注意一下它的类型。在python和C/C++之间有一些自动的类型转换:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">+-------------------------------------------------------------------------------------------+</span>
<span class="o">|</span>                <span class="n">C</span> <span class="n">types</span>                          <span class="o">|</span>  <span class="n">From</span> <span class="n">Python</span> <span class="n">types</span>  <span class="o">|</span>  <span class="n">To</span> <span class="n">Python</span> <span class="n">types</span>  <span class="o">|</span>  
<span class="o">|</span> <span class="p">[</span><span class="n">unsigned</span><span class="p">]</span> <span class="n">char</span> <span class="p">[</span><span class="n">unsigned</span><span class="p">]</span> <span class="n">short</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span>      <span class="o">|</span>  <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span>          <span class="o">|</span>    <span class="nb">int</span>            <span class="o">|</span> 
<span class="o">|</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">unsigned</span> <span class="nb">long</span> <span class="p">[</span><span class="n">unsigned</span><span class="p">]</span> <span class="nb">long</span> <span class="nb">long</span> <span class="o">|</span>  <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span>          <span class="o">|</span>    <span class="nb">long</span>           <span class="o">|</span>  
<span class="o">|</span> <span class="nb">float</span><span class="p">,</span> <span class="n">double</span><span class="p">,</span> <span class="nb">long</span> <span class="n">double</span>                      <span class="o">|</span>  <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span>   <span class="o">|</span>    <span class="nb">float</span>          <span class="o">|</span>   
<span class="o">|</span> <span class="n">char</span><span class="o">*</span>                                           <span class="o">|</span>  <span class="nb">str</span><span class="o">/</span><span class="nb">bytes</span>          <span class="o">|</span>    <span class="nb">str</span><span class="o">/</span><span class="nb">bytes</span>      <span class="o">|</span> 
<span class="o">|</span> <span class="n">struct</span>                                          <span class="o">|</span>                     <span class="o">|</span>    <span class="nb">dict</span>           <span class="o">|</span> 
<span class="o">+-------------------------------------------------------------------------------------------+</span>
</pre></div>
</td></tr></table></div>
<p>由于python的变量是动态类型，解析起来会很慢，所以建议将其显示的指定为C/C++静态类型来提升效果，具体可以看<a href="http://docs.cython.org/src/quickstart/cythonize.html">这篇</a><br>
所谓指定静态类型，就是显示的指定变量的类型。</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">cdef</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="o">...</span>
<span class="n">cdef</span> <span class="nb">int</span> <span class="n">func</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</td></tr></table></div>
<div class="alert alert-info">

    <i class="fa fa-info"></i>

    结论: 指定静态类型大约有35%的提速。
</div><p>另一方面，如果需要检测传入的参数不是<code>None</code>的话可以加上<code>not None</code>来检测</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</td></tr></table></div>
<p>如果要向C传递一个数组来处理，大部分情况下应该是numpy的array，推荐使用Memoryview来接受python传入的numpy的array</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">cdef</span> <span class="nb">int</span><span class="p">[:,:,:]</span> <span class="n">view</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">cdef</span> <span class="nb">int</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
<span class="n">cdef</span> <span class="nb">int</span><span class="p">[:,:,:]</span> <span class="n">view</span> <span class="o">=</span> <span class="n">x</span>
<span class="n">cdef</span> <span class="nb">int</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="mi">1</span><span class="p">]</span> <span class="n">c_contiguous</span> <span class="o">=</span> <span class="n">c_contig</span> <span class="c"># C的按行存储</span>
<span class="n">cdef</span> <span class="nb">int</span><span class="p">[::</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">f_contiguous</span> <span class="o">=</span> <span class="n">f_contig</span> <span class="c"># Fortran的按列存储</span>

<span class="n">cpdef</span> <span class="n">histogram</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,:]</span> <span class="n">image</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="n">cdef</span> <span class="nb">int</span><span class="p">[:]</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">hist</span><span class="p">[</span><span class="n">image</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>你几乎可以像使用numpy的array一样的使用Memoryview，不过仍然有一些限制，<a href="http://docs.cython.org/src/userguide/memoryviews.html">详细内容</a><br>
在一些较老的资料中，你也许会见到像下面这样的写法:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">unsigned</span> <span class="n">char</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">]</span> <span class="n">array</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</td></tr></table></div>
<div class="alert alert-danger">

    <i class="fa fa-bug"></i>

    虽然很明显，但还是得多加注意，Memoryview和array一样，在函数内做了修改，其原值也会修改。
</div><p>至于python的list和dict，我个人习惯直接使用，而不指定静态类型。你也可以看看<a href="http://stackoverflow.com/questions/1528691/idiomatic-way-to-do-list-dict-in-cython?rq=1">这个问题</a>下面的一些关于如何优雅的在Cython中使用list和dict的讨论。</p>
<h3 id="toc-5">C++和面向对象</h3>
<p>在Cython中也可以方便的使用面向对象的方式工作，只要使用<code>cdef class</code>就能在Cython中像在pure Python中那样使用类(当然还是有些限制):</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">cdef</span> <span class="k">class</span> <span class="nc">Rect</span><span class="p">:</span>
    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span> <span class="n">w</span><span class="p">,</span> <span class="nb">int</span> <span class="n">h</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span>
    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span>

<span class="k">def</span> <span class="nf">test_it</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">cdef</span> <span class="n">Rect</span> <span class="n">R</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">R</span><span class="o">.</span><span class="n">area</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>值得注意的是，Cython中的类可以被pure Python中的类继承，但反过来不行.<br>
你还可以像下面这样设置一些属性的getter和setter</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">shop</span><span class="p">:</span>
    <span class="n">cdef</span> <span class="nb">object</span> <span class="n">goods</span>
    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">property</span> <span class="n">goods</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;We have: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">goods</span>
        <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">goods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">goods</span><span class="p">[:]</span>
</pre></div>
</td></tr></table></div>
<p>上面还涉及到<code>__cinit__</code>这个方法和原生python的<code>__init__</code>有些区别，前者可以更快的执行，官方的例子是:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">cdef</span> <span class="k">class</span> <span class="nc">Penguin</span><span class="p">:</span>
    <span class="n">cdef</span> <span class="nb">object</span> <span class="n">food</span>

    <span class="k">def</span> <span class="nf">__cinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">food</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">food</span> <span class="o">=</span> <span class="n">food</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">food</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;eating!&quot;</span><span class="p">)</span>

<span class="n">normal_penguin</span> <span class="o">=</span> <span class="n">Penguin</span><span class="p">(</span><span class="s">&#39;fish&#39;</span><span class="p">)</span>
<span class="n">fast_penguin</span> <span class="o">=</span> <span class="n">Penguin</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">Penguin</span><span class="p">,</span> <span class="s">&#39;wheat&#39;</span><span class="p">)</span>  <span class="c"># note: not calling __init__() !</span>
</pre></div>
</td></tr></table></div>
<p>所以最求效率的化，尽量使用<code>__cinit__</code>吧。对于经常创建/删除实例的类，可以在前面加上<code>@cython.freelist(n)</code>的装饰器。可以获得更好的性能。</p>
<p>如果想使用C++中的STL的话，可以像下面这样:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">libcpp.vector</span> <span class="nn">cimport</span> <span class="nn">vector</span>

<span class="n">cdef</span> <span class="n">vector</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="n">vect</span>
<span class="n">cdef</span> <span class="nb">int</span> <span class="n">i</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">vect</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">vect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">vect</span> <span class="o">=</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>python到C++容器的转换规则是</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">+-------------------------------------------------+</span>
<span class="o">|</span>   <span class="n">Python</span> <span class="nb">type</span>  <span class="o">=&gt;</span>   <span class="n">C</span><span class="o">++</span> <span class="nb">type</span>  <span class="o">=&gt;</span> <span class="n">Python</span> <span class="nb">type</span>    <span class="o">|</span>
<span class="o">|</span><span class="nb">bytes</span>           <span class="o">|</span>  <span class="n">std</span><span class="p">::</span><span class="n">string</span> <span class="o">|</span>   <span class="nb">bytes</span>         <span class="o">|</span>
<span class="o">|</span><span class="n">iterable</span>        <span class="o">|</span>  <span class="n">std</span><span class="p">::</span><span class="n">vector</span> <span class="o">|</span>   <span class="nb">list</span>          <span class="o">|</span>  
<span class="o">|</span><span class="n">iterable</span>        <span class="o">|</span>  <span class="n">std</span><span class="p">::</span><span class="nb">list</span>   <span class="o">|</span>   <span class="nb">list</span>          <span class="o">|</span> 
<span class="o">|</span><span class="n">iterable</span>        <span class="o">|</span>  <span class="n">std</span><span class="p">::</span><span class="nb">set</span>    <span class="o">|</span>   <span class="nb">set</span>           <span class="o">|</span> 
<span class="o">|</span><span class="n">iterable</span><span class="p">(</span><span class="nb">len</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>  <span class="n">std</span><span class="p">::</span><span class="n">pair</span>   <span class="o">|</span>   <span class="nb">tuple</span> <span class="p">(</span><span class="nb">len</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
<span class="o">--------------------------------------------------+</span>
</pre></div>
</td></tr></table></div>
<h2 id="toc-6">直接使用C/C++代码</h2>
<p>如果你恰好已经有了C部分的代码，想直接在python中调用而不是用cython自己重写的话，你只需要写一个.pyx进行简单的封装，就能达到目的。</p>
<h3 id="toc-7">封装</h3>
<p><strong>如果只是一些C的函数需要封装进来</strong><br>
使用<code>cdef extern</code>可以把C代码中的函数声明到cython中:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">cdef</span> <span class="n">extern</span> <span class="nb">int</span> <span class="n">add</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_py</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>当然你得有一个.c的文件来实现add函数</p>
<p><strong>若是有一些C++的类需要封装进来</strong><br>
举个官方的例子，你有一个rectangle.h的头文件，</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">//rectangle.h</span>

<span class="k">namespace</span> <span class="n">shapes</span> <span class="p">{</span>
    <span class="k">class</span> <span class="nc">Rectangle</span> <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="kt">int</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">;</span>
        <span class="n">Rectangle</span><span class="p">(</span><span class="kt">int</span> <span class="n">x0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y1</span><span class="p">);</span>
        <span class="kt">int</span> <span class="nf">getArea</span><span class="p">();</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>一个rectangle.cpp的实现</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">//rectangle.cpp</span>

<span class="cp">#include &quot;Rectangle.h&quot;</span>
<span class="k">namespace</span> <span class="n">shapes</span> <span class="p">{</span>
    <span class="n">Rectangle</span><span class="o">::</span><span class="n">Rectangle</span><span class="p">(</span><span class="kt">int</span> <span class="n">X0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Y0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">X1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Y1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">X0</span><span class="p">;</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">Y0</span><span class="p">;</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">X1</span><span class="p">;</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">Y1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">Rectangle</span><span class="o">::</span><span class="n">getArea</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>那么你还需要一个_rectangle.pyx文件</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># _rectangle.pyx</span>

<span class="n">cdef</span> <span class="n">extern</span> <span class="kn">from</span> <span class="s">&quot;Rectangle.h&quot;</span> <span class="n">namespace</span> <span class="s">&quot;shapes&quot;</span><span class="p">:</span>
    <span class="n">cdef</span> <span class="n">cppclass</span> <span class="n">Rectangle</span><span class="p">:</span>
        <span class="n">Rectangle</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">except</span> <span class="o">+</span>
        <span class="nb">int</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span>
        <span class="nb">int</span> <span class="n">getArea</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="n">cdef</span> <span class="n">Rectangle</span> <span class="o">*</span><span class="n">rec</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Rectangle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">recLength</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">getLength</span><span class="p">()</span>
        <span class="o">...</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">rec</span>     <span class="c"># delete heap allocated object</span>
</pre></div>
</td></tr></table></div>
<p><code>func()</code>就是对外提供的接口。当然如果要对外提供整个类的话，可以用<code>cdef class</code>把整个类都封装一遍。</p>
<div class="alert alert-danger">

    <i class="fa fa-bug"></i>

    pyx文件不要和你的cpp文件重名，不然自动产生的Python-C-API包裹代码会覆盖掉你的源码。
</div><h3 id="toc-8">参数传递</h3>
<p>传递一个值是非常简单的，只要注意类型匹配就可以了，你可以参考<a href="http://docs.scipy.org/doc/numpy/user/basics.types.html">numpy的数据类型</a>来显示的转换它们。<br>
问题是传一个数组的时候，需要传入一个地址，尤其对于多维数组来说，只能把它们当做一维数组在C中处理</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">cdef</span> <span class="n">extern</span> <span class="n">void</span> <span class="n">c_nead_array</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">short</span><span class="o">*</span> <span class="n">arrary</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="nb">int</span><span class="p">[:,:]</span> <span class="n">array</span><span class="p">):</span>
    <span class="n">c_nead_array</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">array</span>
</pre></div>
</td></tr></table></div>
<p>这就传入了一个2d数组的开始地址。这种方式还可以拿来返回输出。因为是传入一个地址。<br>
另外，如果有需要传入一个引用的话，比如C++的某些情况，不能直接使用<code>* ptr</code> 这样做</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cython.operator</span> <span class="nn">cimport</span> <span class="nn">dereference</span> <span class="nn">as</span> <span class="nn">deref</span>

<span class="n">cdef</span> <span class="n">extern</span> <span class="n">func</span><span class="p">(</span><span class="n">Image</span> <span class="n">img</span><span class="p">)</span>
<span class="n">cdef</span> <span class="n">Image</span> <span class="o">*</span><span class="n">imgptr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Image</span><span class="p">()</span>
<span class="n">func</span><span class="p">(</span><span class="n">deref</span><span class="p">(</span><span class="n">imgptr</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<h2 id="toc-9">编写setup.py</h2>
<p>在你搞定了上述的重写或者封装之后，你就需要写一个setup.py来进行编译了，好把你的C/C++模块编进共享库文件中。关于setup.py的一般写法，可以看<a href="https://docs.python.org/2/distutils/setupscript.html">这里</a>，不过在Cython中，还是有些区别的。
如果你只有一个pyx文件.那么下面这么写就足够了</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># setup.py</span>
<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">Cython.Build</span> <span class="kn">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span>
       <span class="s">&quot;test.pyx&quot;</span><span class="p">,</span>
       <span class="n">language</span><span class="o">=</span><span class="s">&quot;c++&quot;</span><span class="p">,</span> <span class="c">## 如果是C++就需要</span>
      <span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>不过我个人更建议下面的写法:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># setup.py</span>
<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">Cython.Build</span> <span class="kn">import</span> <span class="n">cythonize</span>
<span class="kn">from</span> <span class="nn">distutils.extension</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="nn">Cython.Distutils</span> <span class="kn">import</span> <span class="n">build_ext</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="n">extension</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">(</span>
           <span class="s">&quot;sub&quot;</span><span class="p">,</span>
           <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;sub.pyx&quot;</span><span class="p">],</span>
           <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()],</span> <span class="c"># 如果用到numpy</span>
           <span class="n">language</span><span class="o">=</span><span class="s">&quot;c++&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">setup</span><span class="p">(</span>
        <span class="n">cmdclass</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;build_ext&#39;</span><span class="p">:</span> <span class="n">build_ext</span><span class="p">},</span>
        <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="n">extension</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>上面的写法中我们只需要注意Extension的写法，你可以同时编译多个C/C++扩展。</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Extension</span><span class="p">(</span>
           <span class="s">&quot;_test&quot;</span><span class="p">,</span>                             <span class="c"># name1</span>
           <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;_test.pyx&quot;</span><span class="p">,</span> <span class="s">&quot;test.cpp&quot;</span><span class="p">],</span>   <span class="c"># 如果有cpp源码</span>
           <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()],</span>
           <span class="n">language</span><span class="o">=</span><span class="s">&quot;c++&quot;</span><span class="p">),</span>
        <span class="n">Extension</span><span class="p">(</span>
            <span class="s">&quot;_test2&quot;</span><span class="p">,</span>                           <span class="c"># name2</span>
            <span class="n">source</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;_test2.pyx&quot;</span><span class="p">,</span> <span class="s">&quot;test.c&quot;</span><span class="p">],</span>    <span class="c"># ditto</span>
        <span class="p">)</span>
<span class="p">]</span>
</pre></div>
</td></tr></table></div>
<div class="alert alert-danger">

    <i class="fa fa-bug"></i>

    Extension的name务必要和.pyx的文件名要保持一致。
</div><p>最后，你只需要执行setup.py:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>python setup.py build_ext --inplace
</pre></div>
</td></tr></table></div>
<h2 id="toc-10">其他</h2>
<p>写于2015年8月7日by septicmk。<br>
   内容应该足够支持入门了。若版本升级，API变动。或者想有更深入的了解。还得多看看<a href="http://docs.cython.org/index.html">官方文档</a>。<br>
   若文中有误，欢迎指正 :)</p>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES * * */
                    var disqus_shortname = 'septicmk';
                    
                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

                </div>
             </div>
        </div>
    </div>
    <div class="container-narrow">
    <a id="gotop" href="#" style="display: inline;"><span>▲</span></a>
        <footer>
            <p>&copy; 2015 septicmk with help from <a href="https://github.com/lepture/mistune" target="_blank">mistune</a>.
            Theme by <a href="http://github.com/wzpan/hexo-theme-wixo/" target="_blank">Wixo</a></p>
        </footer>
    </div>
    <script src="/source/js/jquery.imagesloaded.min.js"></script>
    <script src="/source/js/gallery.js"></script>
    <script src="/source/js/bootstrap.min.js"></script>
    <script src="/source/js/jquery.tableofcontents.min.js"></script>
    <script src="/source/js/tocgenerator.min.js"></script>
    <script src="/source/js/main.js"></script>
    <link rel="stylesheet" href="/source/fancybox/jquery.fancybox.css" media="screen" type="text/css">
    <script src="/source/fancybox/jquery.fancybox.pack.js"></script>
    <script type="text/javascript">
    (function($){
    $('.fancybox').fancybox();
    })(jQuery);
    </script>
    <script type="text/x-mathjax-config"> 
    MathJax.Hub.Config({ 
        tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]} 
    }); 
    </script>
    <script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
</body>
</html>